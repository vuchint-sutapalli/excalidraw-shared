name: muilti job workflow- Deploy Monorepo to Prod (GCP - Manual)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Brief reason for this manual deployment (e.g., "WIF test", "Backend fix")'
        required: false
        default: "Manual deployment triggered"

env:
  # --- GCP/WIF CONFIGURATION ---
  GCP_PROJECT_ID: "project-716b8f55-83a6-4bef-95a"
  GCP_ZONE: "asia-south1-b"
  GCP_VM_NAME: "instance-slategpt"
  SA_EMAIL: "slategpt@project-716b8f55-83a6-4bef-95a.iam.gserviceaccount.com"
  WIF_PROVIDER: "projects/445521739152/locations/global/workloadIdentityPools/slategpt-pool-id/providers/github"

  # --- APPLICATION ENVIRONMENT VARIABLES ---
  USERNAME: "vuchint_sutapalli"
  NEXT_PUBLIC_WS_URL: wss://prod.ws.slategpt.app
  NEXT_PUBLIC_BACKEND_URL: https://prod.api.slategpt.app
  NODE_VERSION: 20
  ARTIFACT_NAME: web-deployment-artifact # Define artifact name once

jobs:
  ## 1. BUILD AND UPLOAD ARTIFACT (Runs on a fresh Runner instance)
  build_and_package:
    name: ğŸ“¦ Build Frontend Artifact
    runs-on: ubuntu-latest
    permissions:
      contents: "read"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- CRITICAL FIX: Combined Node and PNPM Setup ---
      - name: Setup Node and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          # CRITICAL: This parameter instructs setup-node to install pnpm
          # and ensure it's on the PATH for subsequent steps.
          cache-dependency-path: "pnpm-lock.yaml"
          check-latest: true # Ensures we get a functional version
          registry-url: "https://registry.npmjs.org"
      # --- END CRITICAL FIX ---

      - name: Install dependencies
        run: pnpm install

      - name: Build Next.js app
        run: |
          cd apps/excalidraw-client
          NEXT_PUBLIC_WS_URL=${{ env.NEXT_PUBLIC_WS_URL }} NEXT_PUBLIC_BACKEND_URL=${{ env.NEXT_PUBLIC_BACKEND_URL }} pnpm run build

      - name: Package build folder
        run: tar -czf ${{ env.ARTIFACT_NAME }}.tar.gz -C apps/excalidraw-client .next package.json next.config.mjs public

      - name: Upload Artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}.tar.gz
          retention-days: 1 # Artifact is temporary

  ## 2. PREPARE REMOTE VM AND TRANSFER ARTIFACT
  transfer_and_prep:
    name: ğŸšš Transfer Artifact to VM
    needs: build_and_package
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write" # Need WIF for gcloud commands

    steps:
      - name: Download Artifact from GitHub
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./

      - name: Authenticate to GCP (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.SA_EMAIL }}

      - name: Prepare Remote Deployment Directory
        # Ensure the remote directory exists before we transfer the file
        run: |
          gcloud compute ssh ${{ env.USERNAME }}@${{ env.GCP_VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --command="mkdir -p /home/${{ env.USERNAME }}/deploy_artifacts"

      - name: Copy Build Artifact to VM (GCP Method)
        run: |
          gcloud compute scp ${{ env.ARTIFACT_NAME }}.tar.gz \
            ${{ env.USERNAME }}@${{ env.GCP_VM_NAME }}:/home/${{ env.USERNAME }}/deploy_artifacts/${{ env.ARTIFACT_NAME }}.tar.gz \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --tunnel-through-iap

  ## 3. EXECUTE DEPLOYMENT SCRIPT ON VM
  remote_deploy:
    name: ğŸš€ Execute Remote Deployment
    needs: transfer_and_prep
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Authenticate to GCP (WIF)
        # Re-authenticate, as this is a new job on a potentially new runner machine
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.SA_EMAIL }}

      - name: Execute Remote Deployment Script
        run: |
          # Define Artifact path on the VM
          ARTIFACT_PATH=/home/${{ env.USERNAME }}/deploy_artifacts/${{ env.ARTIFACT_NAME }}.tar.gz

          gcloud compute ssh ${{ env.USERNAME }}@${{ env.GCP_VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --command="
              set -euo pipefail

              # Define variables for the remote script
              DEPLOY_HOME=/home/${{ env.USERNAME }}
              REPO_DIR=\${DEPLOY_HOME}/excalidraw-shared
              ARTIFACT_DIR=\${DEPLOY_HOME}/deploy_artifacts

              echo \"=== ğŸš€ Starting Deployment on \$(hostname) ===\"

              # 1. Load NVM/Node Environment
              export NVM_DIR=\"\${DEPLOY_HOME}/.nvm\"
              [ -s \"\${NVM_DIR}/nvm.sh\" ] && \. \"\${NVM_DIR}/nvm.sh\"
              nvm use default

              # 2. Update Source Code and Install Dependencies
              echo \"1. Checking repository status in \${REPO_DIR}...\"
              cd \${DEPLOY_HOME}

              if [ ! -d \"\${REPO_DIR}/.git\" ]; then
                echo \"   âŒ Repository not found. Cloning now...\"
                git clone https://github.com/vuchint-sutapalli/excalidraw-shared.git \${REPO_DIR}
                cd \${REPO_DIR}
                git checkout production
              else
                echo \"   âœ… Repository found. Pulling latest changes...\"
                cd \${REPO_DIR}
                git fetch origin production
                git reset --hard origin/production
              fi

              echo \"ğŸ“¦ Installing monorepo dependencies...\"
              pnpm install --frozen-lockfile

              # 3. Extract and Configure Frontend
              echo \"ğŸ“¦ Cleaning old frontend build folder...\"
              rm -rf apps/excalidraw-client/.next

              echo \"ğŸ“¦ Extracting new Next.js build...\"
              # CRITICAL: Use the ARTIFACT_PATH defined at the start of this step
              tar -xzf \${ARTIFACT_DIR}/${{ env.ARTIFACT_NAME }}.tar.gz -C apps/excalidraw-client
              echo \"âœ… Extraction complete!\"

              # 4. Database & Backend Build (Secret Injection)
              export DATABASE_URL=\"${{ secrets.DATABASE_URL }}\"

              echo \"ğŸ› ï¸ Running DB Migrations and Generating Client...\"
              pnpm --filter @repo/db db:migrate
              pnpm --filter @repo/db db:generate

              echo \"ğŸ—ï¸ Building lightweight backend apps...\"
              cd apps/http-backend && pnpm run build && cd ../..
              cd apps/ws-backend && pnpm run build && cd ../..

              echo \"ğŸ” Writing runtime .env file...\"
              echo \"DATABASE_URL=\${DATABASE_URL}\" > packages/db/.env

              # 5. Restart PM2 processes
              echo \"ğŸ” Restarting PM2 processes...\"

              pm2 reload http-server || pm2 start dist/index.js --cwd apps/http-backend --name http-server
              pm2 reload ws-server || pm2 start dist/index.js --cwd apps/ws-backend --name ws-server
              pm2 reload fe-server || pm2 start \"pnpm --dir apps/excalidraw-client start\" --name fe-server

              pm2 save

              echo \"âœ… Deployment completed successfully!\"
            "
