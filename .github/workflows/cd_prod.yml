name: Deploy to Production

on:
  push:
    branches: [production]

env:
  HOST: 98.70.42.118
  USERNAME: vuchintbig
  NEXT_PUBLIC_WS_URL: wss://98.70.42.118:8080
  NEXT_PUBLIC_BACKEND_URL: https://98.70.42.118:3001

jobs:
  build:
    name: Build & Package Artifact
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ—ï¸ Build Next.js App
        run: |
          cd apps/excalidraw-client
          NEXT_PUBLIC_WS_URL=${{ env.NEXT_PUBLIC_WS_URL }} NEXT_PUBLIC_BACKEND_URL=${{ env.NEXT_PUBLIC_BACKEND_URL }}} pnpm run build

      - name: ğŸ“¦ Package build artifact
        run: |
          cd apps/excalidraw-client
          echo "Packaging build output..."
          tar -czf ../../web_build.tar.gz .next package.json next.config.mjs public
          echo "âœ… Artifact created at ../../web_build.tar.gz"

      - name: ğŸ§¾ Verify build artifact
        run: ls -lh web_build.tar.gz

      - name: ğŸ’¾ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: web_build
          path: web_build.tar.gz

  deploy:
    name: Deploy to Production VM
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ’¾ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: web_build
          path: .

      - name: Validate SSH Key
        run: |
          if [ -z "${{ secrets.SSH_KEY }}" ]; then
            echo "âŒ SSH key secret not found!"
            exit 1
          fi
          echo "âœ… SSH key is available."

      - name: Setup SSH known hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Copy build artifact to VM
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          source: "web_build.tar.gz"
          target: "/home/${{ env.USERNAME }}/deploy_artifacts/"

      - name: ğŸš€ Deploy on VM
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          timeout: 5m
          script: |
            set -euo pipefail
            echo "=== ğŸš€ Starting Deployment on $(hostname) ==="
            export PATH="/home/${{ env.USERNAME }}/.nvm/versions/node/v24.11.0/bin:$PATH"

            cd /home/${{ env.USERNAME }}/excalidraw-shared || { echo "âŒ Directory not found"; exit 1; }

            echo "ğŸ”„ Pulling latest changes..."
            git fetch origin production
            git reset --hard origin/production

            echo "ğŸ“¦ Installing dependencies..."
            pnpm install --frozen-lockfile

            echo "ğŸ§¹ Cleaning old .next build..."
            rm -rf apps/excalidraw-client/.next

            echo "ğŸ“¦ Extracting new Next.js build..."
            tar -xzf /home/${{ env.USERNAME }}/deploy_artifacts/web_build.tar.gz -C apps/excalidraw-client
            echo "âœ… Extraction complete!"

            echo "ğŸ—ï¸ Building lightweight backend apps..."
            cd apps/http-backend && pnpm run build && cd ../..
            cd apps/ws-backend && pnpm run build && cd ../..

            echo "ğŸ” Restarting PM2 processes..."
            pm2 reload http-server || pm2 start apps/http-backend/dist/index.js --name http-server
            pm2 reload ws-server || pm2 start apps/ws-backend/dist/index.js --name ws-server
            pm2 reload fe-server || pm2 start "pnpm --dir apps/excalidraw-client start" --name fe-server

            pm2 save
            echo "âœ… Deployment completed successfully!"
