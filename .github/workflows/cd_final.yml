name: Deploy to Staging

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy Monorepo to Staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Validate SSH Key
        run: |
          if [ -z "${{ secrets.SSH_KEY }}" ]; then
            echo "âŒ SSH key secret not found!"
            exit 1
          fi
          echo "âœ… SSH key is available."

      - name: Setup SSH known hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy via SSH (Appleboy)
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: 98.70.42.118
          username: vuchintbig
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          timeout: 5m
          script: |
            set -euo pipefail

            echo "=== ğŸš€ Starting Deployment on $(hostname) ==="
            export PATH="/home/vuchintbig/.nvm/versions/node/v24.11.0/bin:$PATH"

            cd /home/vuchintbig/excalidraw-shared || {
              echo "âŒ Directory not found"; exit 1;
            }

            echo "ğŸ”„ Pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main

            echo "ğŸ“¦ Installing dependencies..."
            pnpm install --frozen-lockfile

            echo "ğŸ—ï¸ Building project..."
            pnpm run build

            echo "ğŸ§¹ Cleaning old PM2 processes (if needed)..."
            pm2 save
            pm2 list || true

            echo "ğŸ” Restarting PM2 processes..."
            pm2 reload all || pm2 restart all

            echo "âœ… Deployment completed successfully!"
