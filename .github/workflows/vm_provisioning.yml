name: GCP VM Provisioning (Setup Node/PM2/pnpm)

# Trigger this workflow manually when you need to set up a new VM
on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for running provisioning (e.g., New VM setup)"
        required: false
        default: "Standard environment setup"

# Define the fixed Node version here
env:
  NODE_VERSION_TO_INSTALL: "v24.11.0"

  # --- GCP/WIF CONFIGURATION (Fill in your details) ---
  GCP_PROJECT_ID: "project-716b8f55-83a6-4bef-95a"
  GCP_ZONE: "asia-south1-b"
  GCP_VM_NAME: "instance-slategpt"
  USERNAME: "vuchint_sutapalli"
  SA_EMAIL: "slategpt@project-716b8f55-83a6-4bef-95a.iam.gserviceaccount.com"
  WIF_PROVIDER: "projects/445521739152/locations/global/workloadIdentityPools/slategpt-pool-id/providers/github"

jobs:
  provision_vm:
    name: Install Runtime Environment
    runs-on: ubuntu-latest

    # CRITICAL: Grant permission to the runner to fetch the OIDC token
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Authenticate to GCP (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.SA_EMAIL }}

      - name: Setup VM Environment (NVM, Node, pnpm, PM2)
        run: |
          # The node version is now pulled from the fixed environment variable
          NODE_VERSION=${{ env.NODE_VERSION_TO_INSTALL }}
          PNPM_VERSION=9.0.0
          echo "Target Node Version: $NODE_VERSION"

          gcloud compute ssh ${{ env.USERNAME }}@${{ env.GCP_VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --command="
              set -euo pipefail
              
              # --- 1. NVM INSTALLATION (CONDITIONAL) ---
              if [ ! -d \"\$HOME/.nvm\" ]; then
                echo \"1. NVM not found. Installing NVM...\"

                # Install NVM
                curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash

                # Define NVM environment variables for the current session
                export NVM_DIR=\"\$HOME/.nvm\"
                [ -s \"\$NVM_DIR/nvm.sh\" ] && \. \"\$NVM_DIR/nvm.sh\"

              else
                echo \"1. NVM already installed. Loading NVM...\"
                export NVM_DIR=\"\$HOME/.nvm\"
                [ -s \"\$NVM_DIR/nvm.sh\" ] && \. \"\$NVM_DIR/nvm.sh\"
              fi

              # --- 2. NODE INSTALLATION (VERSION CHECK) ---
              echo \"2. Checking for Node.js ${NODE_VERSION}...\"
              
              # Use the local variable here (it's substituted before running)
              if ! nvm list | grep -q \"v${NODE_VERSION}\"; then
                echo \"   Installing Node.js ${NODE_VERSION}...\"
                nvm install ${NODE_VERSION}
              else
                echo \"   Node.js ${NODE_VERSION} is already installed.\"
              fi

              nvm alias default ${NODE_VERSION}
              
              # Check if pnpm is installed OR if its version is NOT the desired version
              if ! command -v pnpm &> /dev/null || [ \"\$(pnpm --version)\" != \"${PNPM_VERSION}\" ]; then
                echo \"   Installing/Updating pnpm@${PNPM_VERSION} globally...\"
                npm install -g pnpm@${PNPM_VERSION}
              else
                echo \"   pnpm@${PNPM_VERSION} is already installed.\"
              fi

              # --- 4. PM2 INSTALLATION (CONDITIONAL) ---
              echo \"4. Checking for PM2...\"
              if ! command -v pm2 &> /dev/null; then
                echo \"   Installing PM2 globally...\"
                npm install -g pm2
              else
                echo \"   PM2 is already installed.\"
              fi


              echo \"--- üì¶ Checking for Git Utility ---\"

              if ! command -v git &> /dev/null; then
                echo \"   ‚ùå Git not found. Installing now...\"
                sudo apt update -y && sudo apt upgrade -y
                sudo apt install -y git
                echo \"   ‚úÖ Git installed successfully.\"

                sudo apt autoremove -y
                sudo apt clean
              else
                echo \"   ‚úÖ Git is already installed: $(git --version)\"
                sudo apt update -y && sudo apt upgrade -y
                sudo apt autoremove -y
                sudo apt clean
              fi

              echo \"‚úÖ VM Setup Complete. Node version: \$(node -v)\"
            "
